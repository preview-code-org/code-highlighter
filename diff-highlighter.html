<!--
@license
Copyright (c) 2017 Preview-Code. All rights reserved.
This code may only be used under the BSD style license found in LICENSE.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="highlight-import.html">
<link rel="import" href="highlight-styles.html">
<link rel="import" href="../iron-icons/iron-icons.html">

<!--
Syntax highlighting for textual diffs.

@demo demo/index.html
-->
<dom-module id="diff-highlighter">
  <template>

    <style include="highlight-styles">
      :host {
        display: flex;
      }

      #beforeColumn, #afterColumn,#iconColumn {
        padding: 0 4px;
        color: #888;
        background-color: #eee;
        font-family: monospace;
        @apply(--line-number-columns);
      },
      #beforeColumn, #afterColumn {
        width: 2em;
      }
      #beforeColumn > span,
      #afterColumn > span,
      iron-icon {
        @apply(--line-numbers);
        display: block;
        text-align: center;
      }
      #codeColumn {
        overflow-x: auto;
        width: 100%;
        position: relative;
      }
      span {
        line-height: var(--line-height, 24px);
        height: var(--line-height, 24px);
      }
      pre {
        overflow-x: auto;
        line-height: var(--line-height, 24px);
        margin: 0;
      }
      #diffColors {
        width: 100%;
        position: absolute;
        top: 0;
        pointer-events: none;
        z-index: 0;
        right: 0;
        opacity: 0.2;
      }

      #diffColors div {
        height: var(--line-height, 24px);
      }
      #diffColors .add {
        background-color: var(--add-color, green);
      }
      #diffColors .del {
        background-color: var(--add-color, red);
      }
    </style>

    <div id="beforeColumn"></div>
    <div id="afterColumn"></div>
    <div id="iconColumn" on-click="_split"></div>
    <div id="codeColumn">
      <pre><code id="code"></code></pre>
      <div id="diffColors"></div>
    </div>
    

  </template>

  <script>
  Polymer({
    is: 'diff-highlighter',

    observers: [
      '_onDiffChange(code, beforeStart, afterStart)'
    ],

    properties: {
      code: String,
      language: {
        type: String,
        reflectToAttribute: true,
        notify: true
      },
      beforeStart: Number,
      afterStart: Number,
      amountLines: Number
    },

    _onDiffChange: function(code, beforeStart, afterStart) {
      var lines = code.split('\n');

      // The last line may be empty.
      if (code.charAt(code.length-1) === '\n') {
        lines.pop();
      }

      var before = beforeStart;
      var after = afterStart;

      var createSpan = function(content) {
        return '<span>' + content + '</span>';
      }

      var createIcon = function(index, before, after) {
        return '<iron-icon on-click="_split" icon="icons:add-box" index=' + index + ' before=' + before + ' after=' + after  +'></iron-icon>';
      }

      var beforeContent = '';
      var afterContent = '';
      var iconContent = '';
      var strippedCode = [];
      var diffMarks = [];
      lines.forEach(function(line, index) {
        beforeContent += createSpan(line.startsWith('+') ? '' : before++);
        afterContent += createSpan(line.startsWith('-') ? '' : after++);
        iconContent += createIcon(index, before, after);
        strippedCode.push(line.substring(1));
        diffMarks.push(line.charAt(0));
      });

      this.amountLines = lines.length;

      strippedCode = strippedCode.reduce(function(acc, line) {
        return acc + '\n' + line;
      });

      Polymer.dom(this.$.beforeColumn).innerHTML = beforeContent;
      Polymer.dom(this.$.afterColumn).innerHTML = afterContent;    
        
      Polymer.dom(this.$.iconColumn).innerHTML = iconContent;
      
      this.strippedCode = strippedCode;
      var h = hljs.highlightAuto(strippedCode);
      Polymer.dom(this.$.code).innerHTML = h.value;
      this.language = h.language;
      this._updateDiffLines(diffMarks);
    },

    _updateDiffLines: function(marks) {

      var createDiv = function(cls) {
        return '<div class="' + cls + '"></div>';
      }

      var markClass = function(mark) {
        return mark === '+' ? 'add' : mark === '-' ? 'del' : 'normal';
      }

      var content = ''
      marks.forEach(function(mark) {
        content += createDiv(markClass(mark));
      });
      Polymer.dom(this.$.diffColors).innerHTML = content;
    },
    _split: function(e) {
      if (e.path[0].localName === 'iron-icon') {
        var attributes = e.path[0].attributes
        var details = {};
        details.lineNumber = +attributes[2].nodeValue + 1;
        details.clickedBefore = attributes[3].nodeValue;
        details.clickedAfter = attributes[4].nodeValue;
        if (details.lineNumber !== this.amountLines) {
         this.fire('split', details);
        }
      }
    }
  });
  </script>
</dom-module>
